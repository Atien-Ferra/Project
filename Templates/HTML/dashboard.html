{% extends "base.html" %}

{% block title %}Dashboard ‚Ä¢ Focus Flow{% endblock %}

{% block content %}
<div class="py-4">
    <!-- Welcome Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Welcome back, {{ user_name }}! üëã</h1>
            <p class="text-muted mb-0">Let's make today productive.</p>
        </div>
        <div class="d-none d-md-block">
            <span class="badge bg-primary rounded-pill px-3 py-2">
                <i class="bi bi-trophy me-1"></i> {{ total_points|default(0) }} points
            </span>
        </div>
    </div>

    <!-- Notification Bar -->
    {% if notifications %}
    <div class="alert alert-info alert-dismissible fade show shadow-sm mb-4" role="alert" data-notification-bar="1">
        <div class="d-flex align-items-center mb-2">
            <i class="bi bi-bell-fill me-2"></i>
            <strong>Notifications</strong>
        </div>
        <ul class="mb-0">
            {% for notification in notifications %}
            <li>
                {% if notification.type == "task_due" %}
                {% if notification.payload.done %}
                <span class="text-success"><i class="bi bi-check-circle me-1"></i> Task "{{ notification.payload.title
                    }}" is done.</span>
                {% else %}
                <span class="text-warning"><i class="bi bi-clock me-1"></i> Task "{{ notification.payload.title }}"
                    still needs to be done.</span>
                {% endif %}
                {% elif notification.type == "daily_checkin" %}
                <span><i class="bi bi-calendar-check me-1"></i> Don't forget your daily check-in!</span>
                {% elif notification.type == "streak_warning" %}
                <span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i> Warning: Your streak is at
                    risk!</span>
                {% elif notification.type == "reward_earned" %}
                <span class="text-success"><i class="bi bi-trophy me-1"></i> üèÜ You earned: {{ notification.payload.name
                    }}!</span>
                {% endif %}
                <button type="button" class="btn-close btn-sm dismiss-notification"
                    data-notification-id="{{ notification._id }}" aria-label="Close"></button>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Stats Row -->
    <div class="row g-3 mb-4">
        <!-- Streak Card -->
        <div class="col-md-4">
            <div class="card streak h-100 shadow-sm border-0">
                <div class="card-body d-flex align-items-center">
                    <div class="display-5 me-3">üî•</div>
                    <div>
                        <div class="h2 mb-0 fw-bold streak-days">{{ streak }} days</div>
                        <div class="text-muted small">Current Streak</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quizzes Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-primary bg-opacity-10">
                <div class="card-body d-flex align-items-center">
                    <div class="display-5 me-3">üìù</div>
                    <div>
                        <div class="h2 mb-0 fw-bold">{{ quizzes_taken }}</div>
                        <div class="text-muted small">Quizzes Completed</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-success bg-opacity-10">
                <div class="card-body d-flex align-items-center">
                    <div class="display-5 me-3">‚úÖ</div>
                    <div>
                        <div class="h2 mb-0 fw-bold">{{ tasks_done }}</div>
                        <div class="text-muted small">Tasks Completed</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Progress Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-up text-primary me-2"></i>Today's Progress
                        </h5>
                        <span class="badge bg-primary rounded-pill progress-percent">0%</span>
                    </div>
                    <div class="progress" style="height: 12px;">
                        <div class="progress-bar progress-bar-gradient" role="progressbar" style="width: 0%;"
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="small text-muted mt-2 mb-0 tasks-completed">
                        <i class="bi bi-check2-square me-1"></i> 0 of 0 tasks completed
                    </p>
                </div>
            </div>

            <!-- Quiz Upload Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-text me-2"></i>Create a Quiz
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Upload a document to automatically generate a quiz from its content.</p>
                    <form id="uploadForm" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-upload me-1"></i> Upload Document
                            </label>
                            <input class="form-control form-control-lg" type="file" name="file" id="fileUpload"
                                accept=".pdf,.docx,.txt">
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i> Supported: PDF, DOCX, TXT (max 16MB)
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-magic me-2"></i>Generate Quiz
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-task text-primary me-2"></i>Your Tasks
                    </h5>
                    <button class="btn btn-primary btn-sm" id="openTaskModal" type="button">
                        <i class="bi bi-plus-lg me-1"></i> Add Task
                    </button>
                </div>
                <div class="card-body">
                    <!-- Tasks Container -->
                    <div id="tasksContainer">
                        <!-- Tasks will be added here dynamically -->
                    </div>

                    <!-- Empty State -->
                    <div class="empty-state text-center py-5">
                        <div class="display-1 mb-3 text-muted">üìã</div>
                        <h5 class="text-muted">No tasks yet</h5>
                        <p class="text-muted mb-0">Add your first task to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Rewards Card -->
            <div class="card shadow-sm mb-4" id="rewardsContainer">
                <div class="card-header bg-warning bg-opacity-25">
                    <h5 class="mb-0">
                        <i class="bi bi-trophy me-2"></i>Rewards
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Total Points</span>
                        <span class="h4 mb-0 fw-bold text-primary" id="totalPoints">{{ total_points|default(0) }}</span>
                    </div>
                    <hr>
                    <div class="mb-2"><small class="text-muted fw-semibold">Earned Badges</small></div>
                    <div id="rewardsBadges">
                        {% if rewards %}
                        {% for reward in rewards %}
                        <span
                            class="badge {% if reward.tier == 'gold' %}bg-warning text-dark{% elif reward.tier == 'silver' %}bg-secondary{% else %}bg-primary{% endif %} me-1 mb-1"
                            title="{{ reward.description }}">
                            {{ reward.icon }} {{ reward.name }}
                        </span>
                        {% endfor %}
                        {% else %}
                        <span class="text-muted small">Complete tasks to earn rewards!</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Focus Session Card -->
            <div class="card shadow-sm mb-4 bg-dark text-white border-0 overflow-hidden focus-card">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-clock-history me-2"></i>Focus Session
                        </h5>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-light border-0 opacity-75" type="button"
                                id="focusSettings" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark shadow"
                                aria-labelledby="focusSettings">
                                <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Timer Settings</a>
                                </li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-volume-up me-2"></i>Sound
                                        Options</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4 text-center">
                    <!-- Mode Selector -->
                    <div class="btn-group btn-group-sm mb-4 w-100 p-1 bg-white bg-opacity-10 rounded-pill">
                        <button type="button" class="btn rounded-pill focus-mode-btn"
                            data-mode="pomodoro">Pomodoro</button>
                        <button type="button" class="btn rounded-pill focus-mode-btn" data-mode="short_break">Short
                            Break</button>
                        <button type="button" class="btn rounded-pill focus-mode-btn" data-mode="long_break">Long
                            Break</button>
                    </div>

                    <!-- Timer Display -->
                    <div class="py-3">
                        <h1 class="display-2 fw-bold mb-0 timer-number" id="timerDisplay">25:00</h1>
                        <p class="text-white text-opacity-50 small" id="modeDescription">Stay focused for 25 minutes</p>
                    </div>

                    <!-- Progress Indicator -->
                    <div class="progress mb-4 bg-white bg-opacity-10" style="height: 6px;">
                        <div id="timerProgressBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%;"
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>

                    <!-- Controls -->
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <button id="resetTimerBtn"
                            class="btn btn-outline-light rounded-circle border-0 p-2 opacity-50 hover-opacity-100">
                            <i class="bi bi-arrow-counterclockwise fs-4"></i>
                        </button>
                        <button id="startTimerBtn" class="btn btn-light rounded-circle p-3 shadow-lg pulse-animation">
                            <i class="bi bi-play-fill fs-2 text-dark"></i>
                        </button>
                        <button id="pauseTimerBtn" class="btn btn-light rounded-circle p-3 shadow-lg"
                            style="display: none;">
                            <i class="bi bi-pause-fill fs-2 text-dark"></i>
                        </button>
                        <button class="btn btn-outline-light rounded-circle border-0 p-2 opacity-50">
                            <i class="bi bi-skip-forward-fill fs-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Stats Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span><i class="bi bi-fire text-danger me-2"></i>Streak</span>
                            <strong class="stats-streak">{{ streak }} days</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span><i class="bi bi-journal-check text-primary me-2"></i>Quizzes</span>
                            <strong>{{ quizzes_taken }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span><i class="bi bi-check2-all text-success me-2"></i>Tasks Done</span>
                            <strong>{{ tasks_done }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between px-0">
                            <span><i class="bi bi-gem text-info me-2"></i>Points</span>
                            <strong>{{ total_points|default(0) }}</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="taskModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Add a Task
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="csrfToken" value="{{ csrf_token() }}">
                <div class="mb-3">
                    <label for="taskTitleInput" class="form-label fw-semibold">Task Title</label>
                    <input type="text" id="taskTitleInput" class="form-control form-control-lg"
                        placeholder="What do you need to do?">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveTaskBtn" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i>Save Task
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='JS/dashboard/csrf.js') }}"></script>
<script src="{{ url_for('static', filename='JS/dashboard/tasks.js') }}"></script>
<script src="{{ url_for('static', filename='JS/dashboard/progress.js') }}"></script>
<script src="{{ url_for('static', filename='JS/dashboard/rewards.js') }}"></script>
<script src="{{ url_for('static', filename='JS/dashboard/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='JS/dashboard/modal.js') }}"></script>
<script src="{{ url_for('static', filename='JS/dashboard/upload.js') }}"></script>
<script src="{{ url_for('static', filename='JS/dashboard/index.js') }}"></script>
<script src="{{ url_for('static', filename='JS/focus.js') }}"></script>
{% endblock %}